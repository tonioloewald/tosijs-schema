var w=(n)=>({schema:n,_type:null,validate:(u,f)=>c(u,n,f),get optional(){return w({...n,type:Array.isArray(n.type)?[...n.type,"null"]:[n.type,"null"]})},title:(u)=>w({...n,title:u}),describe:(u)=>w({...n,description:u}),default:(u)=>w({...n,default:u}),meta:(u)=>w({...u,...n,...u}),min:(u)=>{let f=n.type==="string"?"minLength":n.type==="array"?"minItems":n.type==="object"?"minProperties":"minimum";return w({...n,[f]:u})},max:(u)=>{let f=n.type==="string"?"maxLength":n.type==="array"?"maxItems":n.type==="object"?"maxProperties":"maximum";return w({...n,[f]:u})},pattern:(u)=>w({...n,pattern:typeof u==="string"?u:u.source}),get email(){return w({...n,format:"email"})},get uuid(){return w({...n,format:"uuid"})},get ipv4(){return w({...n,format:"ipv4"})},get url(){return w({...n,format:"uri"})},get datetime(){return w({...n,format:"date-time"})},get emoji(){return w({...n,pattern:"^\\p{Extended_Pictographic}+$",format:"emoji"})},get int(){return w({...n,type:"integer"})},step:(u)=>w({...n,multipleOf:u})}),H={get email(){return w({type:"string",format:"email"})},get uuid(){return w({type:"string",format:"uuid"})},get ipv4(){return w({type:"string",format:"ipv4"})},get url(){return w({type:"string",format:"uri"})},get datetime(){return w({type:"string",format:"date-time"})},get emoji(){return w({type:"string",pattern:"^\\p{Extended_Pictographic}+$",format:"emoji"})},get any(){return w({})},pattern:(n)=>w({type:"string",pattern:typeof n==="string"?n:n.source}),union:(n)=>w({anyOf:n.map((u)=>u.schema)}),enum:(n)=>w({type:typeof n[0],enum:n}),array:(n)=>w({type:"array",items:n.schema}),tuple:(n)=>w({type:"array",items:n.map((u)=>u.schema),minItems:n.length,maxItems:n.length}),object:(n)=>{let u={},f=[];for(let x in n)if(u[x]=n[x].schema,!Array.isArray(u[x].type)||!u[x].type.includes("null"))f.push(x);return w({type:"object",properties:u,required:f,additionalProperties:!1})},record:(n)=>w({type:"object",additionalProperties:n.schema})},M=new Proxy(H,{get(n,u){if(u in n)return n[u];if(u==="string"||u==="number"||u==="boolean"||u==="integer"){let f=w({type:u});return n[u]=f,f}return}});var K={email:(n)=>/^\S+@\S+\.\S+$/.test(n),uuid:(n)=>/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n),uri:(n)=>{try{return new URL(n),!0}catch{return!1}},ipv4:(n)=>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(n),"date-time":(n)=>!isNaN(Date.parse(n)),emoji:(n)=>new RegExp("\\p{Extended_Pictographic}","u").test(n)};function c(n,u,f){let x=u?.schema||u,I=typeof f==="function"?f:f?.onError,G=typeof f==="object"?f?.fullScan:!1,O=[],t=(y)=>{if(I)I(O.join(".")||"root",y);return!1},g=(y,i)=>{if(i.anyOf){for(let R of i.anyOf)if(c(y,R))return!0;return t("Union mismatch")}if(y===null||y===void 0)return!i.type||Array.isArray(i.type)&&i.type.includes("null")||t("Expected value");let C=Array.isArray(i.type)?i.type[0]:i.type;if(i.enum&&!i.enum.includes(y))return t("Enum mismatch");if(C==="integer"){if(typeof y!=="number"||!Number.isInteger(y))return t("Expected integer")}else if(C==="array"){if(!Array.isArray(y))return t("Expected array")}else if(C==="object"){if(typeof y!=="object"||Array.isArray(y))return t("Expected object")}else if(C&&typeof y!==C)return t(`Expected ${C}`);if(typeof y==="number"){if(i.minimum!==void 0&&y<i.minimum)return t("Value < min");if(i.maximum!==void 0&&y>i.maximum)return t("Value > max");if(i.multipleOf!==void 0&&y%i.multipleOf!==0)return t("Value not step")}if(typeof y==="string"){if(i.minLength!==void 0&&y.length<i.minLength)return t("Len < min");if(i.maxLength!==void 0&&y.length>i.maxLength)return t("Len > max");if(i.pattern&&!new RegExp(i.pattern,i.format==="emoji"?"u":"").test(y))return t("Pattern mismatch");if(i.format&&K[i.format]&&!K[i.format](y))return t("Format invalid")}if(C==="object"){if(i.minProperties!==void 0){let R=0;for(let o in y)if(Object.prototype.hasOwnProperty.call(y,o))R++;if(R<i.minProperties)return t("Too few props")}if(i.required){for(let R of i.required)if(!(R in y))return t(`Missing ${R}`)}if(i.properties){for(let R in i.properties)if(R in y){O.push(R);let o=g(y[R],i.properties[R]);if(O.pop(),!o)return!1}}if(i.additionalProperties){let R=0;for(let o in y){if(i.properties&&o in i.properties)continue;if(!G){if(R++,R%97!==0)continue}O.push(o);let d=g(y[o],i.additionalProperties);if(O.pop(),!d)return!1}}return!0}if(C==="array"&&i.items){let R=y.length;if(i.minItems!==void 0&&R<i.minItems)return t("Array too short");if(i.maxItems!==void 0&&R>i.maxItems)return t("Array too long");if(Array.isArray(i.items)){for(let d=0;d<i.items.length;d++){if(O.push(String(d)),!g(y[d],i.items[d]))return O.pop(),!1;O.pop()}return!0}let o=G||R<=97?1:Math.floor(R/97);for(let d=0;d<R;d+=o){let B=o>1&&d>R-1-o?R-1:d;O.push(String(B));let _=g(y[B],i.items);if(O.pop(),!_)return!1;if(B===R-1)break}return!0}return!0};return g(n,x)}function F(n,u){if(JSON.stringify(n)===JSON.stringify(u))return null;if(n.anyOf||u.anyOf){if(JSON.stringify(n.anyOf)!==JSON.stringify(u.anyOf))return{error:"Union mismatch",from:n.anyOf,to:u.anyOf};return null}if(n.type!==u.type)return{error:`Type mismatch: ${n.type} vs ${u.type}`};if(n.type==="object"){let I={},G=new Set([...Object.keys(n.properties||{}),...Object.keys(u.properties||{})]),O=!1;return G.forEach((t)=>{let g=n.properties?.[t],y=u.properties?.[t];if(!g)I[t]={error:"Added in B"},O=!0;else if(!y)I[t]={error:"Removed in B"},O=!0;else{let i=F(g,y);if(i)I[t]=i,O=!0}}),["minProperties","maxProperties"].forEach((t)=>{if(JSON.stringify(n[t])!==JSON.stringify(u[t]))I[t]={from:n[t],to:u[t]},O=!0}),O?I:null}if(n.type==="array"){if(Array.isArray(n.items)&&Array.isArray(u.items)){if(n.items.length!==u.items.length)return{error:"Tuple length mismatch"};let I={},G=!1;for(let O=0;O<n.items.length;O++){let t=F(n.items[O],u.items[O]);if(t)I[O]=t,G=!0}return G?{items:I}:null}if(!Array.isArray(n.items)&&!Array.isArray(u.items)){let I=F(n.items,u.items);return I?{items:I}:null}return{error:"Array type mismatch (Tuple vs List)"}}let f={},x=!1;return["minimum","maximum","minLength","pattern","format","enum","title","description","default"].forEach((I)=>{if(JSON.stringify(n[I])!==JSON.stringify(u[I]))f[I]={from:n[I],to:u[I]},x=!0}),x?f:null}class P extends Error{kind;functionName;violations;constructor(n,u,f=[]){super(`${n} validation failed for '${u}'`);this.kind=n;this.functionName=u;this.violations=f;this.name="SchemaError"}}class ${registry;constructor(n){return this.registry=n,new Proxy(this,{get:(u,f)=>{if(f in u.registry)return(x)=>u.start(f,x);return}})}static func(n,u,f){let x=async(I)=>{if(!c(I,n.schema,{fullScan:!0}))throw new P("Input","Anonymous",["Input schema mismatch"]);let O=await f(I);if(!c(O,u.schema,{fullScan:!0}))throw new P("Output","Anonymous",["Output schema mismatch"]);return O};return x.input=n,x.output=u,x.impl=f,x._isGuarded=!0,x}start(n,u){let f=this.registry[n],x=(async()=>{if(!f)throw Error(`Function '${n}' not found in registry`);if(!c(u,f.input.schema,{fullScan:!0}))throw new P("Input",n);let I=await f.impl(u);if(!c(I,f.output.schema,{fullScan:!0}))throw new P("Output",n);return I})();return this.createChain(x,this.registry)}createChain(n,u){return new Proxy({},{get:(x,I)=>{if(I==="result")return()=>n;if(I in u)return()=>{let G=n.then(async(O)=>{let t=u[I];if(!t)throw Error(`Function '${I}' not found in registry`);if(!c(O,t.input.schema))throw new P("Input",I,["Chain type mismatch"]);let g=await t.impl(O);if(!c(g,t.output.schema))throw new P("Output",I);return g});return this.createChain(G,u)};return}})}}var h=(n)=>{return new $(n)};export{c as validate,M as s,F as diff,h as createM,P as SchemaError,$ as M};

//# debugId=854E86E71C36CBDA64756E2164756E21
//# sourceMappingURL=index.js.map
